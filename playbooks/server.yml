---

- hosts: all
  gather_facts: false

  roles:
    - facelessvpnserver-system.role
    - facelessvpnserver-strongswan.role
    - facelessvpnserver-freeradius.role

  pre_tasks:

    # Do not assume the inventory_hostname is resolvable and delay 10 seconds at start
    - name: Wait 300 seconds for port 22 to become open and contain "OpenSSH"
      wait_for:
        port: 22
        host: '{{ (ansible_ssh_host|default(ansible_host))|default(inventory_hostname) }}'
        search_regex: OpenSSH
        delay: 10
        timeout: 300

    - name: gather facts
      setup:

    - name: Put SELinux in permissive mode, logging actions that would be blocked.
      selinux:
        state: disabled

    - name: "prepare install epel-release"
      raw: yum -y install epel-release
      changed_when: false

    - name: "prepare: install python2-pip"
      raw: yum -y install python2-pip
      changed_when: false

